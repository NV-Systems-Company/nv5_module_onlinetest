<?php/** * @Project NUKEVIET 4.x * @Author DANGDINHTU (dlinhvan@gmail.com) * @Copyright (C) 2016 Nuke.vn. All rights reserved * @License GNU/GPL version 2 or any later version * @Createdate Mon, 11 Jul 2016 09:00:15 GMT */if ( ! defined( 'NV_IS_MOD_TEST' ) ) die( 'Stop!!!' );$page_title = $lang_module['recharge'];$key_words = $module_info['keywords'];if( ! defined( 'NV_IS_USER' ) ){	$link_redirect = NV_BASE_SITEURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&' . NV_NAME_VARIABLE . '=users&' . NV_OP_VARIABLE . '=login&&nv_redirect=' . nv_redirect_encrypt( $client_info['selfurl'] );	Header( 'Location: ' . $link_redirect );	exit();}if( ACTION_METHOD == 'napthe' ){	define( 'CORE_API_HTTP_USR', $onlineTestConfig['core_api_http_usr'] );	define( 'CORE_API_HTTP_PWD', $onlineTestConfig['core_api_http_pwd'] );	$services = 'https://www.baokim.vn/the-cao/restFul/send';		$token = $nv_Request->get_string( 'token', 'post', '' );		$serinumber = $nv_Request->get_string( 'serinumber', 'post', '' );		$pinnumber = $nv_Request->get_string( 'pinnumber', 'post', '' ); 	$nhacungcap = $nv_Request->get_string( 'chonmang', 'post', '' );  	if( $nhacungcap == 'MOBI' )	{		$ten = 'Mobifone';	}	elseif( $nhacungcap == 'VIETEL' )	{		$ten = 'Viettel';	}	elseif( $nhacungcap == 'GATE' )	{		$ten = 'Gate';	}	elseif( $nhacungcap == 'VTC' )	{		$ten = 'VTC';	}	else  $ten = 'Vinaphone';	//Mã MerchantID dang kí trên Bảo Kim	$merchant_id = $onlineTestConfig['merchant_id'];	//Api username	$api_username = $onlineTestConfig['api_username'];	//Api Pwd  	$api_password = $onlineTestConfig['api_password'];	//Mã TransactionId	$transaction_id = NV_CURRENTTIME;	//mat khau di kem ma website dang kí trên Bảo Kim	$secure_code = $onlineTestConfig['secure_code'];	$arrayPost = array(		'merchant_id' => $merchant_id,		'api_username' => $api_username,		'api_password' => $api_password,		'transaction_id' => $transaction_id,		'card_id' => $nhacungcap,		'pin_field' => $pinnumber,		'seri_field' => $serinumber,		'algo_mode' => 'hmac' );	ksort( $arrayPost );	$data_sign = hash_hmac( 'SHA1', implode( '', $arrayPost ), $secure_code );	$arrayPost['data_sign'] = $data_sign;	$curl = curl_init( $services );	curl_setopt_array( $curl, array(		CURLOPT_POST => true,		CURLOPT_HEADER => false,		CURLINFO_HEADER_OUT => true,		CURLOPT_TIMEOUT => 30,		CURLOPT_RETURNTRANSFER => true,		CURLOPT_SSL_VERIFYPEER => false,		CURLOPT_HTTPAUTH => CURLAUTH_DIGEST | CURLAUTH_BASIC,		CURLOPT_USERPWD => CORE_API_HTTP_USR . ':' . CORE_API_HTTP_PWD,		CURLOPT_POSTFIELDS => http_build_query( $arrayPost ) ) );	$data = curl_exec( $curl );	$status = curl_getinfo( $curl, CURLINFO_HTTP_CODE );	$result = json_decode( $data, true ); 	if( $status == 200 )	{		$amount = $result['amount']; 		$sth = $db_slave->prepare( 'INSERT INTO ' . TABLE_ONLINETEST_NAME . '_recharge SET 			userid= '. intval( $user_info['userid'] ) .',			money='. intval( $amount ) .',			date_added='. intval( NV_CURRENTTIME ) .',			logip=:logip,			seri_number=:seri_number,			pin_number=:pin_number,			supplier=:supplier' );		$sth->bindParam( ':seri_number', $serinumber, PDO::PARAM_STR );		$sth->bindParam( ':pin_number', $pinnumber, PDO::PARAM_STR );		$sth->bindParam( ':supplier', $nhacungcap, PDO::PARAM_STR );		$sth->bindParam( ':logip', $client_info['ip'], PDO::PARAM_STR );		$sth->execute();		$sth->closeCursor();				$db->query( 'INSERT INTO ' . TABLE_ONLINETEST_NAME . '_point (userid, point) VALUES ('. intval( $user_info['userid'] ) .', '. intval( $amount ) .') ON DUPLICATE KEY UPDATE point = point + '. intval( $amount ) );				$json['message'] = vsprintf($lang_module['success_card_recharge_info'], $amount);				$json['success'] = $lang_module['success_card_recharge'];		 	}	else	{		$json['error'] = $result['errorMessage'];		$json['status'] = $status;	}	nv_jsonOutput( $json );}$dataContent = array();$result = $db_slave->query('SELECT * FROM ' . TABLE_ONLINETEST_NAME . '_recharge WHERE userid=' . $user_info['userid'] . ' ORDER BY date_added DESC LIMIT 0,10');while( $rows = $result->fetch()  ){	$dataContent[] = $rows;}$contents = ThemeOnlineTestRecharge( $dataContent );include NV_ROOTDIR . '/includes/header.php';echo nv_site_theme( $contents );include NV_ROOTDIR . '/includes/footer.php';